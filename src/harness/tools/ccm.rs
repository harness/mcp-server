use crate::harness::client::HarnessClient;\nuse crate::types::{HarnessError, Scope};\nuse crate::utils::{extract_string_param, extract_optional_string_param, build_tool_result};\nuse serde_json::{json, Value};\nuse std::collections::HashMap;\n\n/// CCM (Cloud Cost Management) service for cost analysis and management\npub struct CcmService {\n    client: HarnessClient,\n}\n\nimpl CcmService {\n    pub fn new(client: HarnessClient) -> Self {\n        Self { client }\n    }\n\n    /// Get CCM overview for an account\n    pub async fn get_overview(\n        &self,\n        scope: &Scope,\n        start_time: &str,\n        end_time: &str,\n        group_by: &str,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n        params.insert(\"startTime\".to_string(), start_time.to_string());\n        params.insert(\"endTime\".to_string(), end_time.to_string());\n        params.insert(\"groupBy\".to_string(), group_by.to_string());\n\n        let url = format!(\n            \"{}/ccm/api/overview\",\n            self.client.base_url()\n        );\n\n        self.client.get(&url, Some(params)).await\n    }\n\n    /// List CCM cost categories\n    pub async fn list_cost_categories(\n        &self,\n        scope: &Scope,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n\n        let url = format!(\n            \"{}/ccm/api/cost-categories\",\n            self.client.base_url()\n        );\n\n        self.client.get(&url, Some(params)).await\n    }\n\n    /// Get CCM cost category details\n    pub async fn get_cost_category(\n        &self,\n        scope: &Scope,\n        category_id: &str,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n\n        let url = format!(\n            \"{}/ccm/api/cost-categories/{}\",\n            self.client.base_url(),\n            category_id\n        );\n\n        self.client.get(&url, Some(params)).await\n    }\n\n    /// List CCM perspectives\n    pub async fn list_perspectives(\n        &self,\n        scope: &Scope,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n\n        let url = format!(\n            \"{}/ccm/api/perspectives\",\n            self.client.base_url()\n        );\n\n        self.client.get(&url, Some(params)).await\n    }\n\n    /// Get CCM perspective details\n    pub async fn get_perspective(\n        &self,\n        scope: &Scope,\n        perspective_id: &str,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n\n        let url = format!(\n            \"{}/ccm/api/perspectives/{}\",\n            self.client.base_url(),\n            perspective_id\n        );\n\n        self.client.get(&url, Some(params)).await\n    }\n\n    /// Get perspective cost data for last period\n    pub async fn get_perspective_cost(\n        &self,\n        scope: &Scope,\n        perspective_id: &str,\n        start_time: &str,\n        end_time: &str,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n        params.insert(\"startTime\".to_string(), start_time.to_string());\n        params.insert(\"endTime\".to_string(), end_time.to_string());\n\n        let url = format!(\n            \"{}/ccm/api/perspectives/{}/cost\",\n            self.client.base_url(),\n            perspective_id\n        );\n\n        self.client.get(&url, Some(params)).await\n    }\n\n    /// Create a new CCM perspective\n    pub async fn create_perspective(\n        &self,\n        scope: &Scope,\n        perspective_data: Value,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n\n        let url = format!(\n            \"{}/ccm/api/perspectives\",\n            self.client.base_url()\n        );\n\n        self.client.post(&url, Some(params), Some(perspective_data)).await\n    }\n\n    /// Update an existing CCM perspective\n    pub async fn update_perspective(\n        &self,\n        scope: &Scope,\n        perspective_id: &str,\n        perspective_data: Value,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n\n        let url = format!(\n            \"{}/ccm/api/perspectives/{}\",\n            self.client.base_url(),\n            perspective_id\n        );\n\n        self.client.put(&url, Some(params), Some(perspective_data)).await\n    }\n\n    /// Delete a CCM perspective\n    pub async fn delete_perspective(\n        &self,\n        scope: &Scope,\n        perspective_id: &str,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n\n        let url = format!(\n            \"{}/ccm/api/perspectives/{}\",\n            self.client.base_url(),\n            perspective_id\n        );\n\n        self.client.delete(&url, Some(params)).await\n    }\n\n    /// Get CCM recommendations\n    pub async fn list_recommendations(\n        &self,\n        scope: &Scope,\n        resource_type: Option<&str>,\n        limit: Option<u32>,\n        offset: Option<u32>,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n        \n        if let Some(rt) = resource_type {\n            params.insert(\"resourceType\".to_string(), rt.to_string());\n        }\n        if let Some(l) = limit {\n            params.insert(\"limit\".to_string(), l.to_string());\n        }\n        if let Some(o) = offset {\n            params.insert(\"offset\".to_string(), o.to_string());\n        }\n\n        let url = format!(\n            \"{}/ccm/api/recommendations\",\n            self.client.base_url()\n        );\n\n        self.client.get(&url, Some(params)).await\n    }\n\n    /// Get CCM anomalies summary\n    pub async fn get_anomalies_summary(\n        &self,\n        scope: &Scope,\n        start_time: &str,\n        end_time: &str,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n        params.insert(\"startTime\".to_string(), start_time.to_string());\n        params.insert(\"endTime\".to_string(), end_time.to_string());\n\n        let url = format!(\n            \"{}/ccm/api/anomalies/summary\",\n            self.client.base_url()\n        );\n\n        self.client.get(&url, Some(params)).await\n    }\n\n    /// List CCM anomalies\n    pub async fn list_anomalies(\n        &self,\n        scope: &Scope,\n        start_time: &str,\n        end_time: &str,\n        limit: Option<u32>,\n        offset: Option<u32>,\n    ) -> Result<Value, HarnessError> {\n        let mut params = HashMap::new();\n        params.insert(\"accountIdentifier\".to_string(), scope.account_id.clone());\n        params.insert(\"startTime\".to_string(), start_time.to_string());\n        params.insert(\"endTime\".to_string(), end_time.to_string());\n        \n        if let Some(l) = limit {\n            params.insert(\"limit\".to_string(), l.to_string());\n        }\n        if let Some(o) = offset {\n            params.insert(\"offset\".to_string(), o.to_string());\n        }\n\n        let url = format!(\n            \"{}/ccm/api/anomalies\",\n            self.client.base_url()\n        );\n\n        self.client.get(&url, Some(params)).await\n    }\n}\n\n/// Tool handler for getting CCM overview\npub async fn get_ccm_overview_handler(\n    params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let start_time = extract_string_param(&params, \"startTime\")?;\n    let end_time = extract_string_param(&params, \"endTime\")?;\n    let group_by = extract_string_param(&params, \"groupBy\")?;\n\n    let service = CcmService::new(client.clone());\n    let result = service.get_overview(scope, &start_time, &end_time, &group_by).await?;\n    \n    build_tool_result(\"CCM Overview\", result)\n}\n\n/// Tool handler for listing CCM cost categories\npub async fn list_ccm_cost_categories_handler(\n    _params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let service = CcmService::new(client.clone());\n    let result = service.list_cost_categories(scope).await?;\n    \n    build_tool_result(\"CCM Cost Categories\", result)\n}\n\n/// Tool handler for getting CCM cost category details\npub async fn get_ccm_cost_category_handler(\n    params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let category_id = extract_string_param(&params, \"categoryId\")?;\n\n    let service = CcmService::new(client.clone());\n    let result = service.get_cost_category(scope, &category_id).await?;\n    \n    build_tool_result(\"CCM Cost Category\", result)\n}\n\n/// Tool handler for listing CCM perspectives\npub async fn list_ccm_perspectives_handler(\n    _params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let service = CcmService::new(client.clone());\n    let result = service.list_perspectives(scope).await?;\n    \n    build_tool_result(\"CCM Perspectives\", result)\n}\n\n/// Tool handler for getting CCM perspective details\npub async fn get_ccm_perspective_handler(\n    params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let perspective_id = extract_string_param(&params, \"perspectiveId\")?;\n\n    let service = CcmService::new(client.clone());\n    let result = service.get_perspective(scope, &perspective_id).await?;\n    \n    build_tool_result(\"CCM Perspective\", result)\n}\n\n/// Tool handler for getting CCM perspective cost data\npub async fn get_ccm_perspective_cost_handler(\n    params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let perspective_id = extract_string_param(&params, \"perspectiveId\")?;\n    let start_time = extract_string_param(&params, \"startTime\")?;\n    let end_time = extract_string_param(&params, \"endTime\")?;\n\n    let service = CcmService::new(client.clone());\n    let result = service.get_perspective_cost(scope, &perspective_id, &start_time, &end_time).await?;\n    \n    build_tool_result(\"CCM Perspective Cost\", result)\n}\n\n/// Tool handler for creating CCM perspective\npub async fn create_ccm_perspective_handler(\n    params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let perspective_data = params.get(\"perspectiveData\")\n        .ok_or_else(|| HarnessError::Validation(\"perspectiveData parameter is required\".to_string()))?\n        .clone();\n\n    let service = CcmService::new(client.clone());\n    let result = service.create_perspective(scope, perspective_data).await?;\n    \n    build_tool_result(\"Created CCM Perspective\", result)\n}\n\n/// Tool handler for updating CCM perspective\npub async fn update_ccm_perspective_handler(\n    params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let perspective_id = extract_string_param(&params, \"perspectiveId\")?;\n    let perspective_data = params.get(\"perspectiveData\")\n        .ok_or_else(|| HarnessError::Validation(\"perspectiveData parameter is required\".to_string()))?\n        .clone();\n\n    let service = CcmService::new(client.clone());\n    let result = service.update_perspective(scope, &perspective_id, perspective_data).await?;\n    \n    build_tool_result(\"Updated CCM Perspective\", result)\n}\n\n/// Tool handler for deleting CCM perspective\npub async fn delete_ccm_perspective_handler(\n    params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let perspective_id = extract_string_param(&params, \"perspectiveId\")?;\n\n    let service = CcmService::new(client.clone());\n    let result = service.delete_perspective(scope, &perspective_id).await?;\n    \n    build_tool_result(\"Deleted CCM Perspective\", result)\n}\n\n/// Tool handler for listing CCM recommendations\npub async fn list_ccm_recommendations_handler(\n    params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let resource_type = extract_optional_string_param(&params, \"resourceType\");\n    let limit = params.get(\"limit\").and_then(|v| v.as_u64()).map(|v| v as u32);\n    let offset = params.get(\"offset\").and_then(|v| v.as_u64()).map(|v| v as u32);\n\n    let service = CcmService::new(client.clone());\n    let result = service.list_recommendations(scope, resource_type.as_deref(), limit, offset).await?;\n    \n    build_tool_result(\"CCM Recommendations\", result)\n}\n\n/// Tool handler for getting CCM anomalies summary\npub async fn get_ccm_anomalies_summary_handler(\n    params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let start_time = extract_string_param(&params, \"startTime\")?;\n    let end_time = extract_string_param(&params, \"endTime\")?;\n\n    let service = CcmService::new(client.clone());\n    let result = service.get_anomalies_summary(scope, &start_time, &end_time).await?;\n    \n    build_tool_result(\"CCM Anomalies Summary\", result)\n}\n\n/// Tool handler for listing CCM anomalies\npub async fn list_ccm_anomalies_handler(\n    params: Value,\n    client: &HarnessClient,\n    scope: &Scope,\n) -> Result<Value, HarnessError> {\n    let start_time = extract_string_param(&params, \"startTime\")?;\n    let end_time = extract_string_param(&params, \"endTime\")?;\n    let limit = params.get(\"limit\").and_then(|v| v.as_u64()).map(|v| v as u32);\n    let offset = params.get(\"offset\").and_then(|v| v.as_u64()).map(|v| v as u32);\n\n    let service = CcmService::new(client.clone());\n    let result = service.list_anomalies(scope, &start_time, &end_time, limit, offset).await?;\n    \n    build_tool_result(\"CCM Anomalies\", result)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::test_utils::*;\n\n    #[tokio::test]\n    async fn test_get_ccm_overview() {\n        let client = create_test_client();\n        let scope = create_test_scope();\n        let service = CcmService::new(client);\n\n        // This would require a mock server for actual testing\n        // For now, we just test that the service can be created\n        assert_eq!(service.client.base_url(), \"https://app.harness.io\");\n    }\n\n    #[test]\n    fn test_ccm_overview_handler_params() {\n        let params = json!({\n            \"startTime\": \"01/01/2024\",\n            \"endTime\": \"01/31/2024\",\n            \"groupBy\": \"day\"\n        });\n\n        let start_time = extract_string_param(&params, \"startTime\").unwrap();\n        let end_time = extract_string_param(&params, \"endTime\").unwrap();\n        let group_by = extract_string_param(&params, \"groupBy\").unwrap();\n\n        assert_eq!(start_time, \"01/01/2024\");\n        assert_eq!(end_time, \"01/31/2024\");\n        assert_eq!(group_by, \"day\");\n    }\n\n    #[test]\n    fn test_ccm_perspective_handler_params() {\n        let params = json!({\n            \"perspectiveId\": \"test-perspective-123\"\n        });\n\n        let perspective_id = extract_string_param(&params, \"perspectiveId\").unwrap();\n        assert_eq!(perspective_id, \"test-perspective-123\");\n    }\n\n    #[test]\n    fn test_ccm_recommendations_handler_params() {\n        let params = json!({\n            \"resourceType\": \"EC2\",\n            \"limit\": 50,\n            \"offset\": 0\n        });\n\n        let resource_type = extract_optional_string_param(&params, \"resourceType\");\n        let limit = params.get(\"limit\").and_then(|v| v.as_u64()).map(|v| v as u32);\n        let offset = params.get(\"offset\").and_then(|v| v.as_u64()).map(|v| v as u32);\n\n        assert_eq!(resource_type, Some(\"EC2\".to_string()));\n        assert_eq!(limit, Some(50));\n        assert_eq!(offset, Some(0));\n    }\n}